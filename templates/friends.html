{% extends "base.html" %}
{% set active_page = "friends" %}
{% block title %}Friends{% endblock %}
{% block head %}
{% endblock %}
{% block content %}

{% macro render_thumbnails(profiles) -%}
  {% for profile in profiles %}
    <div class="col-sm-4 col-md-3">
      <div class="thumbnail">
        <img src="https://graph.facebook.com/{{ profile['id'] }}/picture?width=200" style="height:200px;vertical-align:middle" alt="pic_big" />
        <div class="caption">
          <h3>{{ profile.name|escape }}</h3>
          {% if profile.about_me %}
            <p>{{ profile.about_me|escape }}</p>
          {% endif %}
          <p>
            <a href="{{ profile['link'] }}" class="btn btn-default" role="button"><span class="glyphicon glyphicon-user"></a>
            <a class="msg_link btn btn-primary" role="button" target="_blank" href="https://m.facebook.com/messages/thread/{{ profile.uid }}/"><span class="glyphicon glyphicon-envelope msg" id="msg_{{ profile.uid }}"></span></a>
            <a  class="vouch_link btn btn-primary" 
                role="button" href="#" 
                data-connector="{{ profile['id'] }}"
                data-connector-profile-pic="{{ profile['picture']['data']['url'] }}"
                data-location-lat="{{ userprefs.search_lat }}"
                data-location-lng="{{ userprefs.search_lng }}"
                data-location-name="{{ location_name }}">
                <span class="glyphicon glyphicon-question-sign"></span>
            </a>
            <span>{{ profile.mutual_friend_count|default('?') }} mutual</span>
          </p>
        </div>
      </div>
    </div>
  {% endfor %}
{%- endmacro %}

{% macro render_thumbnails_dict(profiles) -%}
  {% for uid, profile in profiles %}
  <div class="col-sm-4 col-md-3">
    <div class="thumbnail">
      <img src="https://graph.facebook.com/{{ profile['id'] }}/picture?width=200" style="height:200px;vertical-align:middle" alt="pic_big" />
      <div class="caption">
        <h3>{{ profile.name|escape }}</h3>
        {% if profile.about_me %}
          <p>{{ profile.about_me|escape }}</p>
        {% endif %}
        <p>
          <a href="{{ profile.profile_url }}" class="btn btn-default" role="button"><span class="glyphicon glyphicon-user"></a>
          <a class="msg_link btn btn-primary" role="button" target="_blank" href="https://m.facebook.com/messages/thread/{{ profile.uid }}/"><span class="glyphicon glyphicon-envelope msg" id="msg_{{ profile.uid }}"></span></a>
          <span>{{ profile.friends|length }} mutual</span>
        </p>
      </div>
    </div>
  </div>
  {% endfor %}
{%- endmacro %}


  {% if user %}

  <div class="row">
    <div class="">

      {% if friends_local|length > 0 %}
      <p>1st degree <b>app user</b> friends in {{ location_name }}: {{ friends_local|length }}</p>
      <div class="row">
        {{ render_thumbnails(friends_local) }}
      </div>
      {% endif %}

      <div class="alert alert-info">
        <span class="glyphicon glyphicon-info-sign"></span>
        2nd degree connections are only visible through a 1st degree app user.
        <a href="#" id="sendRequest" data-message="Hi, accept this app so I can connect through you to people you may know in {{ location_name }} while I'm traveling.">Invite your friends to see more!</a>
      </div>

      {% if friends_local_2|length > 0 %}
      <p>2nd degree friends in {{ location_name }}: {{ friends_local_2|length }}</p>
      <div class="row">
        {{ render_thumbnails_dict(friends_local_2.iteritems()) }}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}


  <div id="result"></div>

  <script type="text/javascript">
    if (!('ontouchstart' in window)) {
      $(".msg_link").attr('href', '#');
      $(".msg_link").removeAttr("target");
      $('.msg').click(function() {
        var uid = $(this).attr('id').replace('msg_','');
        FB.ui({
          method: 'send',
          to: uid,
          name: 'Facebook Dialogs',
          link: '{{ location_link }}',
          });
      });
    }
  </script>

  <script type="text/javascript">
    var objectToLike = 'http://techcrunch.com/2013/02/06/facebook-launches-developers-live-video-channel-to-keep-its-developer-ecosystem-up-to-date/';
    $('#sendRequest').click(function() {
      FB.ui(
        {
          method  : 'apprequests',
          title   : 'Invite people to connect through',
          message : $(this).attr('data-message'),
          {% if friends_local_not_user_uid_list|length > 0 %}
          filters : [{name: '{{ location_name|truncate(19, True) }} friends', user_ids: {{ friends_local_not_user_uid_list }}}],
          {% else %}
          filters : ['app_non_users'],
          {% endif %}
        },
        function (response) {
          // If response is null the user canceled the dialog
          if (response != null) {
            console.log(response);
          }
        }
      );
    });
  </script>
  
  <script type="text/javascript">
    $('.vouch_link').click(function() {
      FB.api(
        'me/objects/friends_by_location:vouch',
        'post',
        { access_token : '{{ user.access_token }}',
        	object : {
        	  "fb:app_id": '{{ facebook_app_id }}',
            "og:title": 'Vouch',
            "og:type": 'friends_by_location:vouch',
            "og:image": $(this).attr('data-connector-profile-pic'),
            "og:description": 'Should this traveler be vouched for? Would they get along with this local? Comment below.',
            "friends_by_location:connector": $(this).attr('data-connector'),
            "friends_by_location:local": 663108670,
            "friends_by_location:location:latitude": $(this).attr('data-location-lat'),
            "friends_by_location:location:longitude": $(this).attr('data-location-lng'),
            "friends_by_location:location_name": "{{ location_name }}"
          }
        },
        function(response) {
          if (!response) {
            alert('Error occurred.');
          } else if (response.error) {
              console.log('Error: ' + response.error.message);
          } else {
        	  console.log(
              '<a href=\"https://graph.facebook.com/' +
              response.id + '\">' +
              'Object created.  ID is ' +
              response.id + '</a>'
            );
            FB.api(
              'me/friends_by_location:request',
              'post',
              {
              	vouch: response.id 
              },
              function(response2) {
                if (!response2) {
                  alert('Error occurred.');
                } else if (response2.error) {
                	console.log('Error: ' + response2.error.message);
                } else {
                	console.log(
                    '<a href=\"https://www.facebook.com/me/activity/' +
                    response2.id + '\">' +
                    'Story created.  ID is ' +
                    response2.id + '</a>'
                  );
                }
              }
            );
          }
        }
      );
    });
  </script>
  
  <script type="text/javascript">
    var objectToLike = 'http://techcrunch.com/2013/02/06/facebook-launches-developers-live-video-channel-to-keep-its-developer-ecosystem-up-to-date/';
    function postLike() {
      FB.api(
         'https://graph.facebook.com/me/og.likes',
         'post',
         { object: objectToLike,
           privacy: {'value': 'SELF'} },
         function(response) {
           if (!response) {
             alert('Error occurred.');
           } else if (response.error) {
             document.getElementById('result').innerHTML =
               'Error: ' + response.error.message;
           } else {
             document.getElementById('result').innerHTML =
               '<a href=\"https://www.facebook.com/me/activity/' +
               response.id + '\">' +
               'Story created.  ID is ' +
               response.id + '</a>';
           }
         }
      );
    }
  </script>
{% endblock %}
