{% extends "base.html" %}
{% block title %}Friends{% endblock %}
{% block head %}
{% endblock %}
{% block content %}

{% macro render_thumbnails(profiles) -%}
  {% for profile in profiles %}
    <div class="col-sm-4 col-md-3">
      <div class="thumbnail">
        <img src="{{ profile.pic_big }}" style="height:200px;vertical-align:middle" alt="pic_big" />
        <div class="caption">
          <h3>{{ profile.name|escape }}</h3>
          {% if profile.about_me %}
            <p>{{ profile.about_me|escape }}</p>
          {% endif %}
          <p>
            <a href="{{ profile.profile_url }}" class="btn btn-default" role="button"><span class="glyphicon glyphicon-user"></a>
            <a class="msg_link btn btn-primary" role="button" target="_blank" href="https://m.facebook.com/messages/thread/{{ profile.uid }}/"><span class="glyphicon glyphicon-envelope msg" id="msg_{{ profile.uid }}"></span></a>
            <span class="btn btn-default">{{ profile.mutual_friend_count }} mutual</span>
          </p>
        </div>
      </div>
    </div>
  {% endfor %}
{%- endmacro %}

  {% if user %}

  <div class="row">
    <div class="">

      {% if friends_local_user|length > 0 %}
      <p>1st degree <b>app user</b> friends in {{ location_name }}: {{ friends_local_user|length }}</p>
      <div class="row">
        {{ render_thumbnails(friends_local_user) }}
      </div>
      {% endif %}

      {% if friends_local_not_user|length > 0 %}
      <p>1st degree friends in {{ location_name }}: {{ friends_local_not_user|length }}</p>
      <div class="row">
        {{ render_thumbnails(friends_local_not_user) }}
      </div>
      {% endif %}

      <div class="alert alert-info">
        <span class="glyphicon glyphicon-info-sign"></span>
        2nd degree connections are only visible through a 1st degree app user.
        <a href="#" id="sendRequest" data-message="Hi, accept this app so I can connect through you to people you may know in {{ location_name }} while I'm traveling.">Invite your friends to see more!</a>
      </div>

      {% if friends_friends_local_not_user|length > 0 %}
      <p>2nd degree friends in {{ location_name }}: {{ friends_friends_local_not_user|length }}</p>
      <ul class="list-group">
        {% for uid, friend in friends_friends_local_not_user.iteritems() %}
          <li class="list-group-item">
            <a href="{{ friend.profile_url }}"><img src="{{ friend.pic_big }}" style="height:200px;vertical-align:middle"/>{{ friend.name|escape }}</a>
            <a class="msg_link" target="_blank" href="https://m.facebook.com/messages/thread/{{ friend.uid }}/"><span class="glyphicon glyphicon-envelope msg" id="msg_{{ friend.uid }}"></span></a>
            <span class="badge">{{ friend.friends|length }}</span>
            {% if friend.friends|length > 0 %}
            <ul class="list-group">
              <li class="list-group-item">
              {% for friend_of_friend in friend.friends %}
                <a href="{{ friend_of_friend.profile_url }}"><img src="{{ friend_of_friend.pic_big }}" style="height:32px;vertical-align:middle"/></a>
              {% endfor %}
            </li>
            </ul>
            {% endif %}
          </li>
        {% endfor %}
        </ul>
        {% endif %}
    </div>
  </div>

  {% endif %}



  <script>
    if (!('ontouchstart' in window)) {
      $(".msg_link").attr('href', '#');
      $(".msg_link").removeAttr("target");
      $('.msg').click(function() {
        var uid = $(this).attr('id').replace('msg_','');
        FB.ui({
          method: 'send',
          to: uid,
          name: 'Facebook Dialogs',
          link: '{{ location_link }}',
          });
      });
    }
  </script>

  <script type="text/javascript">
    $('#sendRequest').click(function() {
      FB.ui(
        {
          method  : 'apprequests',
          title   : 'Invite people to connect through',
          message : $(this).attr('data-message'),
          {% if friends_local_not_user_uid_list|length > 0 %}
          filters : [{name: '{{ location_name|truncate(19, True) }} friends', user_ids: {{ friends_local_not_user_uid_list }}}],
          {% else %}
          filters : ['app_non_users'],
          {% endif %}
        },
        function (response) {
          // If response is null the user canceled the dialog
          if (response != null) {
            console.log(response);
          }
        }
      );
    });
  </script>
{% endblock %}
